import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';

const SerpentLoader = ({ size = 120, duration = 1800, onComplete }) => {
  const [isVisible, setIsVisible] = useState(true);
  const [isMobile, setIsMobile] = useState(false);

  useEffect(() => {
    const checkMobile = () => setIsMobile(window.innerWidth < 768);
    checkMobile();
    window.addEventListener('resize', checkMobile);
    return () => window.removeEventListener('resize', checkMobile);
  }, []);

  useEffect(() => {
    const timer = setTimeout(() => {
      setIsVisible(false);
      if (onComplete) onComplete();
    }, duration + 600); // Wait for exit animation

    return () => clearTimeout(timer);
  }, [duration, onComplete]);

  const containerStyle = {
    position: 'fixed',
    top: 0,
    left: 0,
    width: '100vw',
    height: '100vh',
    zIndex: 9999,
    background: 'rgba(255, 255, 255, 0.95)',
    backdropFilter: 'blur(4px)',
    display: 'flex',
    alignItems: 'center',
    justifyContent: 'center',
  };

  const actualSize = isMobile ? 80 : size;

  // Animation Variants

  // Phase 1: Crescent (Path 1)
  const crescentVariant = {
    hidden: { opacity: 0 },
    visible: {
      opacity: 1,
      transition: {
        duration: 0.6,
        ease: [0.4, 0, 0.2, 1]
      }
    }
  };

  // Phase 2: Snake Body (Other paths)
  // Converting fill to stroke animation effect
  const snakeBodyVariant = (custom) => ({
    hidden: {
      pathLength: 0,
      fillOpacity: 0,
      strokeOpacity: 1
    },
    visible: {
      pathLength: 1,
      fillOpacity: 1,
      strokeOpacity: 0,
      transition: {
        pathLength: { delay: 0.4 + (custom * 0.1), duration: 1, ease: "easeInOut" },
        fillOpacity: { delay: 0.4 + (custom * 0.1) + 0.5, duration: 0.5 }, // Fill in as it draws or after
        strokeOpacity: { delay: 0.4 + (custom * 0.1) + 0.8, duration: 0.2 }
      }
    }
  });

  // Phase 3: Global Fade In / Scale Adjustment
  // We apply this to the SVG container itself
  const svgVariant = {
    hidden: { opacity: 0.8, scale: 0.95 },
    visible: {
      opacity: 1,
      scale: 1,
      transition: {
        delay: 1.4,
        duration: 0.4
      }
    },
    exit: {
      opacity: 0,
      scale: 0.9,
      transition: { duration: 0.5 }
    }
  };

  return (
    <AnimatePresence>
      {isVisible && (
        <motion.div
          style={containerStyle}
          initial={{ opacity: 0 }}
          animate={{ opacity: 1 }}
          exit={{ opacity: 0 }}
          transition={{ duration: 0.3 }}
        >
          <motion.svg
            xmlns="http://www.w3.org/2000/svg"
            xmlnsXlink="http://www.w3.org/1999/xlink"
            width={actualSize}
            height={actualSize}
            viewBox="0 0 1024 1024"
            initial="hidden"
            animate="visible"
            exit="exit"
            variants={svgVariant}
          >
            <defs>
              <linearGradient id="gradient_0" gradientUnits="userSpaceOnUse" x1="566.28589" y1="339.24051" x2="417.88837" y2="289.04501">
                <stop offset="0" stopColor="#1BB9A2" />
                <stop offset="1" stopColor="#5CE0BA" />
              </linearGradient>
              <linearGradient id="gradient_1" gradientUnits="userSpaceOnUse" x1="482.30365" y1="556.39923" x2="489.49615" y2="564.3288">
                <stop offset="0" stopColor="white" stopOpacity="0.10196079" />
                <stop offset="1" stopColor="white" stopOpacity="0.17647059" />
              </linearGradient>
              <linearGradient id="gradient_2" gradientUnits="userSpaceOnUse" x1="487.621" y1="549.87036" x2="483.88171" y2="549.59271">
                <stop offset="0" stopColor="white" stopOpacity="0.19607843" />
                <stop offset="1" stopColor="white" stopOpacity="0.24313726" />
              </linearGradient>
            </defs>

            {/* Path 1: Crescent (Phase 1) */}
            <motion.path
              fill="url(#gradient_0)"
              d="M491.467 344.409C488.429 343.419 485.275 342.459 482.319 341.321C440.876 325.373 419.056 278.504 435.035 236.702C437.451 230.381 440.19 222.91 444.598 217.911C440.963 233.754 440.556 245.876 446.686 261.484C453.996 279.391 467.408 291.844 484.927 299.413C514.632 312.248 546.473 302.685 566.365 277.766C571.4 271.457 574.757 264.229 577.867 256.698C580.164 247.147 580.492 244.822 580.636 235.148C580.479 229.2 580.413 224.41 579.156 218.541C584.81 227.004 587.238 232.329 590.012 242.218C597.486 266.907 591.617 300.196 572.724 318.582C561.415 333.486 547.478 339.004 530.964 344.802C530.272 370.276 531.177 396.068 531.054 421.567C531.029 426.664 531.907 433.122 530.931 438.007C518.423 437.655 503.367 438.344 491.402 437.448C490.901 430.939 491.617 421.096 491.474 414.102C491.005 391.185 492.304 367.189 491.467 344.409Z"
              variants={crescentVariant}
            />

            {/* Path 2 */}
            <motion.path
              fill="#3ABFA3"
              stroke="#3ABFA3" strokeWidth="20"
              d="M572.724 318.582C572.821 315.798 573.995 315.063 575.257 312.589C574.866 309.63 574.749 306.755 574.556 303.798C574.026 295.655 572.16 291.172 575.389 283.253C576.88 283.281 577.325 283.377 578.777 282.998C578.849 281.599 578.576 280.875 578.234 279.536L578.787 278.756C580.764 278.682 580.567 279.082 582.631 280.521L583.499 280.244C587.648 271.753 580.24 261.159 583.874 252.182C585.218 248.862 587.491 244.695 590.012 242.218C597.486 266.907 591.617 300.196 572.724 318.582Z"
              variants={snakeBodyVariant(0)}
              custom={0}
            />

            {/* Path 3 */}
            <motion.path
              fill="#3ABFA3"
              stroke="#3ABFA3" strokeWidth="20"
              d="M580.636 235.148C581.654 236.736 580.939 243.621 582.207 247.838C580.921 250.292 580.175 251.706 579.597 254.48C579.246 256.169 579.23 255.782 577.867 256.698C580.164 247.147 580.492 244.822 580.636 235.148Z"
              variants={snakeBodyVariant(1)}
              custom={1}
            />

            {/* Path 4 */}
            <motion.path
              fill="#1A988B"
              stroke="#1A988B" strokeWidth="20"
              d="M427.332 478.274C426.658 476.447 420.875 473.898 418.864 472.413C415.455 469.896 404.46 462.403 404.734 457.872C408.971 456.195 419.343 443.91 424.262 440.779C424.865 440.395 426.752 440.04 428.24 439.322C428.993 438.202 429.084 438.008 430.045 437.085L430.97 437.381C435.446 443.204 442.971 449.419 450.764 447.135C459.98 446.687 473.114 446.402 482.551 446.919C508.183 448.321 543.018 444.008 567.79 448.175C587.778 451.536 605.216 477.21 605.96 497.749C606.412 512.115 601.074 526.06 591.147 536.454C581.028 547.223 569.619 552.041 554.961 552.39C550.037 552.482 545.112 552.504 540.188 552.456L540.102 518.286C549.76 518.087 558.633 520.288 565.679 512.87C569.272 509.156 571.114 504.087 570.744 498.932C569.26 477.832 543.869 482.925 529 482.76C510.805 482.558 492.513 483.32 474.283 482.657C463.526 482.428 436.17 484.374 427.332 478.274Z"
              variants={snakeBodyVariant(2)}
              custom={2}
            />

            {/* Path 5 */}
            <motion.path
              fill="#0F7776"
              stroke="#0F7776" strokeWidth="20"
              d="M470.281 519.922C475.29 518.756 476.917 518.364 482.057 519.151C482.025 526.201 481.756 535.731 482.205 542.643L482.014 545.497C481.127 546.229 481.603 546.03 480.641 546.211C475.029 546.888 472.001 547.639 468.301 552.285C463.094 558.823 464.076 569.228 471.055 574.064C476.453 577.806 483.486 577.07 489.707 577.017C499.778 576.864 509.849 576.774 519.921 576.746C538.588 576.734 552.009 575.676 566.315 590.137C572.07 595.912 576.008 603.247 577.644 611.235C583.042 636.852 566.225 660.241 540.051 663.043C540.08 655.635 539.901 647.111 540.179 639.799C545.543 637.304 550.228 635.032 552.188 629.047C555.754 618.157 551.237 608.472 540.033 605.326C534.061 603.65 527.922 604.263 521.887 604.319L493.22 604.538C472.498 604.623 456.554 605.477 443.048 584.722C442.655 584.119 441.431 581.596 441.239 581.041C429.021 557.287 443.291 522.673 470.281 519.922Z"
              variants={snakeBodyVariant(3)}
              custom={3}
            />

            {/* Path 6 */}
            <motion.path
              fill="#1A988B"
              stroke="#1A988B" strokeWidth="20"
              d="M441.239 581.041C429.021 557.287 443.291 522.673 470.281 519.922L473.748 520.119C471.944 520.89 469.171 520.772 467.103 521.374C462.965 522.579 458.649 524.907 454.931 527.048L452.44 531.808L449.546 532.333C444.482 537.862 438.909 545.721 438.331 553.455C438.209 555.086 439.734 557.889 439.684 559.94C439.588 563.897 437.326 566.443 437.961 570.491C438.551 574.256 441.304 577.306 441.239 581.041Z"
              variants={snakeBodyVariant(4)}
              custom={4}
            />

            {/* Path 7 */}
            <motion.path
              fill="#3ABFA3"
              stroke="#3ABFA3" strokeWidth="20"
              d="M427.332 478.274C381.377 459.549 383.397 391.619 429.374 374.613C440.31 370.568 451.146 370.862 462.6 370.891C468.911 370.906 475.737 370.385 481.956 371.121C482.348 375.209 482.049 381.092 482.065 385.318C482.091 392.225 482.159 399.271 482.023 406.168C475.718 405.819 449.717 405.501 444.757 406.571C441.827 407.214 439.071 408.487 436.682 410.3C420.702 422.415 430.061 445.5 450.764 447.135C442.971 449.419 435.446 443.204 430.97 437.381L430.045 437.085C429.084 438.008 428.993 438.202 428.24 439.322C426.752 440.04 424.865 440.395 424.262 440.779C419.343 443.91 408.971 456.195 404.734 457.872C404.46 462.403 415.455 469.896 418.864 472.413C420.875 473.898 426.658 476.447 427.332 478.274Z"
              variants={snakeBodyVariant(5)}
              custom={5}
            />

            {/* Path 8 */}
            <motion.path
              fill="#1A988B"
              stroke="#1A988B" strokeWidth="20"
              d="M578.084 361.139C582.973 360.755 586.577 361.129 591.307 362.255C613.239 367.474 655.137 386.207 614.634 405.307C607.229 408.799 600.578 411.45 592.388 413.453C575.767 416.766 568.681 414.52 555.347 406.73C554.026 405.958 542.613 406.362 540.012 406.359L540.015 370.772C543.994 370.558 550.999 371.255 554.783 369.987C565.465 366.41 566.294 363.285 578.084 361.139ZM595.23 390.113C598.837 388.945 600.843 385.102 599.739 381.475C598.635 377.848 594.829 375.774 591.183 376.813C588.766 377.502 586.909 379.442 586.326 381.886C585.742 384.331 586.524 386.9 588.37 388.606C590.216 390.311 592.839 390.888 595.23 390.113Z"
              variants={snakeBodyVariant(6)}
              custom={6}
            />

            {/* Path 9 */}
            <motion.path
              fill="#0F7776"
              stroke="#0F7776" strokeWidth="20"
              d="M491.344 613.276C502.444 612.66 519.084 613.212 530.577 613.239C530.769 617.063 530.78 621.353 530.733 625.235C530.456 648.382 531.924 671.896 530.282 694.939C530.138 696.966 527.114 701.027 525.734 702.564C517.59 709.952 505.146 710.643 496.928 702.795C495.254 701.197 492.493 696.962 492.17 694.631C490.625 683.477 491.785 671.829 491.408 660.558C491.607 645.014 490.858 628.544 491.344 613.276Z"
              variants={snakeBodyVariant(7)}
              custom={7}
            />

            {/* Path 10 */}
            <motion.path
              fill="#1A988B"
              stroke="#1A988B" strokeWidth="20"
              d="M491.399 492.073C498.172 491.588 523.732 491.376 530.668 491.949C531.014 498.405 530.934 505.518 530.836 512.019C530.553 530.627 531.228 549.42 531.056 568.001C521.046 567.893 499.934 568.578 491.215 567.7L491.033 566.754C491.427 561.893 491.336 557.122 491.038 552.263C491.343 538.93 491.463 525.594 491.396 512.258C491.378 505.94 490.909 498.139 491.399 492.073Z"
              variants={snakeBodyVariant(8)}
              custom={8}
            />

            {/* Path 11 (Gradient) */}
            <motion.path
              fill="url(#gradient_1)"
              d="M482.205 542.643C483.005 544.042 482.797 544.018 482.942 545.639C485.684 544.39 485.658 543.67 488.152 545.414C486.618 545.499 484.88 545.426 483.784 546.563C482.89 547.479 482.456 548.748 482.603 550.02C482.962 553.251 486.05 554.656 488.827 552.717C490.36 556.722 487.516 565.367 488.633 567.874C490.075 567.746 489.629 567.725 491.033 566.754L491.215 567.7C490.33 568.888 488.753 570.773 487.096 570.588C476.882 569.448 486.595 560.641 481.879 556.19C479.105 553.572 480.951 553.916 480.727 551.985L479.733 551.557L478.487 552.178C477.788 550.199 479.571 547.615 481.43 546.723L480.641 546.211C481.603 546.03 481.127 546.229 482.014 545.497L482.205 542.643Z"
              variants={snakeBodyVariant(9)}
              custom={9}
            />

            {/* Path 12 */}
            <motion.path
              fill="#FFFEFF" fillOpacity="0.086274512"
              d="M488.152 545.414L490.095 545.508C491.577 548.202 488.9 550.795 491.038 552.263C491.336 557.122 491.427 561.893 491.033 566.754C489.629 567.725 490.075 567.746 488.633 567.874C487.516 565.367 490.36 556.722 488.827 552.717L488.778 552.154C489.551 550.759 489.566 550.871 489.573 549.292C488.604 547.612 488.415 547.315 488.152 545.414Z"
              variants={snakeBodyVariant(10)}
              custom={10}
            />

            {/* Path 13 (Gradient) */}
            <motion.path
              fill="url(#gradient_2)"
              d="M488.152 545.414C488.415 547.315 488.604 547.612 489.573 549.292C489.566 550.871 489.551 550.759 488.778 552.154L488.827 552.717C486.05 554.656 482.962 553.251 482.603 550.02C482.456 548.748 482.89 547.479 483.784 546.563C484.88 545.426 486.618 545.499 488.152 545.414Z"
              variants={snakeBodyVariant(11)}
              custom={11}
            />
          </motion.svg>
        </motion.div>
      )}
    </AnimatePresence>
  );
};

export default SerpentLoader;

{% extends 'base.html' %}
{% block title %}Accueil Secr√©tariat - TBIB{% endblock %}

{% block content %}
<div class="min-h-screen bg-gray-50" x-data="secretaryApp()">

    <!-- Header -->
    <div class="bg-white border-b border-gray-200 px-6 py-4">
        <div class="flex items-center justify-between">
            <div>
                <h1 class="text-2xl font-bold text-gray-900">üè• Secr√©tariat</h1>
                <p class="text-sm text-gray-500">
                    Cabinet du <strong>Dr. {{ doctor.user.name }}</strong> - {{ doctor.specialty }}
                </p>
            </div>
            <div class="text-right">
                <p class="text-sm text-gray-400">{{ today.strftime('%A %d %B %Y') }}</p>
                <p class="text-2xl font-bold text-[#14b999]" x-text="currentTime"></p>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto px-4 py-6">

        <!-- Stats Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <p class="text-xs text-gray-400 uppercase tracking-wider">En Attente</p>
                <p class="text-3xl font-bold text-orange-500" x-text="stats.waiting"></p>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <p class="text-xs text-gray-400 uppercase tracking-wider">Pr√©sents</p>
                <p class="text-3xl font-bold text-[#14b999]" x-text="stats.checked_in"></p>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <p class="text-xs text-gray-400 uppercase tracking-wider">Termin√©s</p>
                <p class="text-3xl font-bold text-gray-400" x-text="stats.completed"></p>
            </div>
            <div class="bg-white rounded-xl p-4 shadow-sm border border-gray-100">
                <p class="text-xs text-gray-400 uppercase tracking-wider">Total Jour</p>
                <p class="text-3xl font-bold text-blue-600" x-text="stats.total"></p>
            </div>
        </div>

        <div class="grid lg:grid-cols-3 gap-6">

            <!-- Actions Rapides -->
            <div class="lg:col-span-1 space-y-4">

                <!-- Bouton Check-in G√âANT -->
                <button @click="showCheckinModal = true"
                    class="w-full bg-gradient-to-r from-[#14b999] to-[#0d9479] hover:from-[#0d9479] hover:to-[#0a7a62] text-white rounded-2xl p-8 shadow-lg hover:shadow-xl transition-all transform hover:-translate-y-1">
                    <div class="text-center">
                        <span class="text-6xl block mb-3">‚úã</span>
                        <span class="text-2xl font-bold block">CHECK-IN PATIENT</span>
                        <span class="text-sm opacity-80">Le patient est arriv√©</span>
                    </div>
                </button>

                <!-- Bouton Nouveau RDV -->
                <button @click="showNewApptModal = true"
                    class="w-full bg-white hover:bg-gray-50 text-gray-700 rounded-2xl p-6 shadow-sm border-2 border-dashed border-gray-300 hover:border-[#14b999] transition-all">
                    <div class="text-center">
                        <span class="text-4xl block mb-2">üìû</span>
                        <span class="text-lg font-bold block">Nouveau RDV Rapide</span>
                        <span class="text-sm text-gray-400">Appel t√©l√©phonique</span>
                    </div>
                </button>

                <!-- Prochains patients -->
                <div class="bg-white rounded-xl shadow-sm border border-gray-100 p-4">
                    <h3 class="font-bold text-gray-700 mb-3 flex items-center gap-2">
                        <span>‚è∞</span> Prochains Patients
                    </h3>
                    <div class="space-y-2">
                        <template x-for="appt in nextAppointments" :key="appt.id">
                            <div class="flex items-center justify-between py-2 border-b border-gray-50 last:border-0">
                                <div>
                                    <p class="font-medium text-gray-900" x-text="appt.patient_name"></p>
                                    <p class="text-xs text-gray-400" x-text="appt.reason || 'Consultation'"></p>
                                </div>
                                <span class="text-sm font-mono font-bold text-[#14b999]" x-text="appt.time"></span>
                            </div>
                        </template>
                        <template x-if="nextAppointments.length === 0">
                            <p class="text-gray-400 text-sm text-center py-4">Aucun RDV √† venir</p>
                        </template>
                    </div>
                </div>
            </div>

            <!-- Liste Salle d'Attente -->
            <div class="lg:col-span-2">
                <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 flex items-center justify-between">
                        <h2 class="font-bold text-gray-900 flex items-center gap-2">
                            <span class="text-xl">ü™ë</span> Salle d'Attente
                        </h2>
                        <span class="px-3 py-1 bg-[#14b999]/10 text-[#14b999] rounded-full text-sm font-bold"
                            x-text="waitingRoom.length + ' patient(s)'"></span>
                    </div>

                    <div class="divide-y divide-gray-50">
                        <template x-for="patient in waitingRoom" :key="patient.id">
                            <div class="p-4 flex items-center justify-between hover:bg-gray-50 transition">
                                <div class="flex items-center gap-4">
                                    <div class="w-12 h-12 rounded-full bg-[#14b999]/10 flex items-center justify-center text-[#14b999] font-bold"
                                        x-text="patient.name.split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase()">
                                    </div>
                                    <div>
                                        <p class="font-bold text-gray-900" x-text="patient.name"></p>
                                        <p class="text-sm text-gray-400">
                                            Arriv√© √† <span class="font-mono" x-text="patient.arrival_time"></span>
                                            <span class="mx-1">‚Ä¢</span>
                                            <span x-text="patient.wait_time + ' min d\'attente'"></span>
                                        </p>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <span
                                        class="px-3 py-1 bg-orange-100 text-orange-700 rounded-full text-xs font-bold">
                                        En attente
                                    </span>
                                </div>
                            </div>
                        </template>
                        <template x-if="waitingRoom.length === 0">
                            <div class="p-12 text-center text-gray-400">
                                <span class="text-4xl block mb-2">üèñÔ∏è</span>
                                <p>Salle d'attente vide</p>
                            </div>
                        </template>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- MODALE : Check-in Patient -->
    <div x-show="showCheckinModal" x-cloak
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
        @click.self="showCheckinModal = false">
        <div class="bg-white rounded-2xl shadow-2xl max-w-lg w-full mx-4 overflow-hidden" @click.stop>
            <div class="p-6 border-b border-gray-100 bg-[#14b999] text-white">
                <h3 class="text-xl font-bold flex items-center gap-2">
                    <span class="text-2xl">‚úã</span> Check-in Patient
                </h3>
                <p class="text-sm opacity-80">S√©lectionnez le patient qui vient d'arriver</p>
            </div>
            <div class="p-6 max-h-96 overflow-y-auto">
                <input type="text" x-model="searchPatient" placeholder="Rechercher un patient..."
                    class="w-full px-4 py-3 border border-gray-200 rounded-lg mb-4 focus:ring-2 focus:ring-[#14b999]/20">

                <div class="space-y-2">
                    <template x-for="appt in filteredAppointments" :key="appt.id">
                        <!-- Optimistic UI Check-in Button -->
                        <button x-data="{ state: 'waiting', loading: false }"
                                @click="
                                    prev = state; state = 'present'; loading = true; // 1. Optimism
                                    fetch('/api/secretary/checkin/'+appt.id, {
                                        method: 'POST',
                                        headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
                                    })
                                    .then(r => {
                                        if(!r.ok) { state = prev; showToast('Erreur', 'error'); }
                                        else { $dispatch('patient-checked-in'); }
                                    }) // 2. Rollback si erreur
                                    .finally(() => loading = false)"
                                :class="state === 'present' ? 'bg-green-500 text-white border-green-600' : 'bg-white hover:bg-[#14b999]/5 border-gray-100 hover:border-[#14b999]'"
                                class="w-full text-left p-4 rounded-xl border-2 transition relative overflow-hidden">

                            <div class="flex items-center justify-between relative z-10">
                                <div>
                                    <p class="font-bold" :class="state === 'present' ? 'text-white' : 'text-gray-900'" x-text="appt.patient_name"></p>
                                    <p class="text-sm" :class="state === 'present' ? 'text-green-100' : 'text-gray-400'"
                                        x-text="'RDV ' + appt.time + ' - ' + (appt.reason || 'Consultation')"></p>
                                </div>
                                <div x-show="loading" class="animate-spin h-6 w-6 border-2 border-current border-t-transparent rounded-full"></div>
                                <span x-show="!loading && state !== 'present'" class="text-2xl">‚Üí</span>
                                <span x-show="!loading && state === 'present'" class="text-2xl">‚úì</span>
                            </div>
                        </button>
                    </template>
                </div>
            </div>
            <div class="p-4 bg-gray-50 border-t border-gray-100">
                <button @click="showCheckinModal = false"
                    class="w-full py-2 text-gray-600 hover:bg-gray-200 rounded-lg transition">
                    Fermer
                </button>
            </div>
        </div>
    </div>

    <!-- MODALE : Nouveau RDV Rapide -->
    <div x-show="showNewApptModal" x-cloak
        class="fixed inset-0 z-50 flex items-center justify-center bg-black/50 backdrop-blur-sm"
        @click.self="showNewApptModal = false">
        <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 overflow-hidden" @click.stop>
            <div class="p-6 border-b border-gray-100">
                <h3 class="text-lg font-bold flex items-center gap-2">
                    <span class="text-2xl">üìû</span> Nouveau RDV Rapide
                </h3>
            </div>
            <form @submit.prevent="createQuickAppointment()" class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Nom du Patient *</label>
                    <input type="text" x-model="newAppt.patient_name" required dir="auto"
                        class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#14b999]/20"
                        placeholder="ŸÖÿ≠ŸÖÿØ / Mohamed">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">T√©l√©phone *</label>
                    <input type="tel" x-model="newAppt.phone" required
                        class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#14b999]/20"
                        placeholder="05XX XX XX XX">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Date</label>
                        <input type="date" x-model="newAppt.date"
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#14b999]/20">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Heure</label>
                        <input type="time" x-model="newAppt.time"
                            class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#14b999]/20">
                    </div>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Motif</label>
                    <input type="text" x-model="newAppt.reason" dir="auto"
                        class="w-full px-3 py-2 border border-gray-200 rounded-lg focus:ring-2 focus:ring-[#14b999]/20"
                        placeholder="Consultation / ŸÅÿ≠ÿµ">
                </div>
                <button type="submit"
                    class="w-full py-3 bg-[#14b999] hover:bg-[#0d9479] text-white rounded-lg font-bold transition">
                    ‚úÖ Cr√©er le RDV
                </button>
            </form>
            <div class="p-4 bg-gray-50 border-t border-gray-100">
                <button @click="showNewApptModal = false"
                    class="w-full py-2 text-gray-600 hover:bg-gray-200 rounded-lg transition">
                    Annuler
                </button>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div x-show="toast.show" x-cloak x-transition
        class="glass-panel fixed bottom-6 right-6 z-50 px-6 py-3 rounded-xl shadow-lg font-medium border border-white/50 backdrop-blur-xl"
        :class="toast.type === 'success' ? 'bg-green-500/90 text-white' : 'bg-red-500/90 text-white'" x-text="toast.message">
    </div>
</div>

<style>
    [x-cloak] {
        display: none !important;
    }
</style>

<script>
    function secretaryApp() {
        return {
            currentTime: '',
            showCheckinModal: false,
            showNewApptModal: false,
            searchPatient: '',
            appointments: [],
            waitingRoom: [],
            stats: { waiting: 0, checked_in: 0, completed: 0, total: 0 },
            newAppt: {
                patient_name: '',
                phone: '',
                date: new Date().toISOString().split('T')[0],
                time: '',
                reason: ''
            },
            toast: { show: false, message: '', type: 'success' },

            init() {
                this.updateTime();
                setInterval(() => this.updateTime(), 1000);
                this.fetchData();
                setInterval(() => this.fetchData(), 30000);

                // Listen for optimistic check-ins
                window.addEventListener('patient-checked-in', () => {
                     setTimeout(() => {
                         this.showToast('Patient enregistr√© en salle d\'attente');
                         this.showCheckinModal = false;
                         this.fetchData();
                     }, 500); // Small delay to let animation finish
                });
            },

            updateTime() {
                this.currentTime = new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
            },

            showToast(message, type = 'success') {
                this.toast = { show: true, message, type };
                setTimeout(() => this.toast.show = false, 3000);
            },

            async fetchData() {
                try {
                    const today = new Date().toISOString().split('T')[0];
                    const response = await fetch(`/api/secretary/appointments?date=${today}`);
                    if (response.ok) {
                        const data = await response.json();
                        this.appointments = data.appointments || [];
                        this.waitingRoom = data.waiting_room || [];
                        this.stats = data.stats || this.stats;
                    }
                } catch (error) {
                    console.error('Error fetching data:', error);
                }
            },

            get nextAppointments() {
                return this.appointments
                    .filter(a => a.status === 'confirmed')
                    .slice(0, 5);
            },

            get filteredAppointments() {
                const search = this.searchPatient.toLowerCase();
                return this.appointments
                    .filter(a => a.status === 'confirmed')
                    .filter(a => !search || a.patient_name.toLowerCase().includes(search));
            },

            async checkInPatient(appointmentId) {
                try {
                    const response = await fetch(`/api/secretary/checkin/${appointmentId}`, {
                        method: 'POST',
                        headers: { 'X-CSRFToken': '{{ csrf_token() }}' }
                    });
                    if (response.ok) {
                        this.showToast('Patient enregistr√© en salle d\'attente');
                        this.showCheckinModal = false;
                        this.fetchData();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    this.showToast('Erreur lors du check-in', 'error');
                }
            },

            async createQuickAppointment() {
                try {
                    const response = await fetch('/api/secretary/quick-appointment', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'X-CSRFToken': '{{ csrf_token() }}'
                        },
                        body: JSON.stringify(this.newAppt)
                    });
                    if (response.ok) {
                        this.showToast('RDV cr√©√© avec succ√®s');
                        this.showNewApptModal = false;
                        this.newAppt = { patient_name: '', phone: '', date: new Date().toISOString().split('T')[0], time: '', reason: '' };
                        this.fetchData();
                    }
                } catch (error) {
                    console.error('Error:', error);
                    this.showToast('Erreur lors de la cr√©ation', 'error');
                }
            }
        }
    }
</script>
{% endblock %}
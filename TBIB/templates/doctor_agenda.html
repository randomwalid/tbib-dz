{% extends 'layout_doctor.html' %}

{% block title %}Agenda - TBIB{% endblock %}
{% block page_title %}Agenda{% endblock %}
{% block page_subtitle %}Vue calendrier compl√®te{% endblock %}

{% block head %}
<link href='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css' rel='stylesheet' />
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js'></script>
{% endblock %}

{% block content %}
<div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6">
    <div id="calendar"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    var calendarEl = document.getElementById('calendar');
    var calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'timeGridWeek',
        locale: 'fr',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        slotMinTime: '07:00:00',
        slotMaxTime: '21:00:00',
        allDaySlot: false,
        nowIndicator: true,
        height: 'auto',
        events: '/api/doctor/appointments',
        eventClick: function(info) {
            const props = info.event.extendedProps;
            const patientData = {
                name: props.patient_name,
                age: props.patient_age || '',
                blood_type: props.blood_type || '',
                reliability_score: props.reliability_score || 100,
                appointment_id: info.event.id,
                patient_id: props.patient_id,
                phone: props.patient_phone || '',
                email: props.patient_email || '',
                consultation_reason: props.consultation_reason || '',
                consultation_type: props.consultation_type || 'Consultation',
                status: props.status,
                doctor_notes: props.doctor_notes || '',
                allergies: props.allergies || '',
                medical_history: props.medical_history || '',
                history_html: props.history_html || ''
            };
            if (window.Alpine && Alpine.store) {
                Alpine.store('patientPanel').show(patientData);
            }
        },
        eventDidMount: function(info) {
            const props = info.event.extendedProps;
            if (props.is_shadow_slot) {
                info.el.style.background = 'repeating-linear-gradient(-45deg, #fef3c7, #fef3c7 5px, #fde68a 5px, #fde68a 10px)';
                info.el.style.borderLeft = '3px solid #f59e0b';
            }
            if (props.urgency_level >= 4) {
                info.el.style.borderLeft = '3px solid #ef4444';
            }
        }
    });
    calendar.render();
});
</script>

<style>
.fc-event {
    cursor: pointer;
    border-radius: 8px;
    padding: 4px 8px;
    font-size: 12px;
}
.fc-toolbar-title {
    font-size: 1.25rem !important;
    font-weight: 700 !important;
    color: #333;
}
.fc-button-primary {
    background-color: #14b999 !important;
    border-color: #14b999 !important;
}
.fc-button-primary:hover {
    background-color: #0d9479 !important;
}
.fc-button-primary:not(:disabled).fc-button-active {
    background-color: #0d9479 !important;
}
</style>
{% endblock %}
